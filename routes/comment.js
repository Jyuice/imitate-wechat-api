const router = require('koa-router')()const bodyParser = require('koa-bodyparser')const query = require('../module/query')const getTime = require('../module/getCompleteTime')router.use(bodyParser())// 获取朋友圈的评论（仅共友）router.get('/getComments', async ctx => {    const { userId, momentId } = ctx.query    const sql =     //"SELECT DISTINCT comments.m_id AS comment_id,comments.mor_id AS commentor_id,comments.u_id AS moment_id,comments.uor AS opposite,users.nickname,users.avatar,comments.content AS comment,comments.type,comments.time FROM comments LEFT JOIN users ON comments.mor_id=users.user_id LEFT JOIN relation ON users.user_id=relation.user_id OR users.user_id=relation.friend_id WHERE comments.u_id='"+ momentId +"' AND (relation.friend_id='"+ userId +"' OR relation.user_id='"+ userId +"') ORDER BY comments.time"    // "SELECT DISTINCT responses.response_id,responses.responser_id,responses.moment_id,users.nickname AS commentor,users.avatar, responses.content, responses.type, responses.commentor AS opposite, responses.time FROM responses LEFT JOIN users ON responses.responser_id=users.user_id LEFT JOIN relation ON users.user_id=relation.user_id OR users.user_id=relation.friend_id WHERE responses.moment_id='"+ momentId +"' AND (relation.friend_id='"+ userId +"' OR relation.user_id='"+ userId +"') ORDER BY responses.time"    `CALL get_responses(${userId}, ${momentId})`    const doc = await query(sql)    const data = {        status: 200,        list: doc[0]    }    ctx.body = data})// 提交评论router.post('/postComment', async ctx => {    const { userId, momentId,comment } = ctx.request.body    const completeTime = getTime()    // 此处用触发器，使朋友圈的comment_num+1    await query("INSERT INTO responses (responser_id,moment_id,content,type,time) VALUES ('"+ userId +"','"+ momentId +"','"+ comment +"',0,'"+ completeTime +"')")    // await query("INSERT INTO comments (commentor_id,comment,moment_id,time) VALUES ('"+ userId +"','"+ comment +"','"+ momentId +"','"+ completeTime +"')")    const data = {        status: 200    }    ctx.body = data})// 删除评论router.post("/deleteComment", async ctx => {    const { userId, commentId } = ctx.request.body    // await query("DELETE comments,replies FROM comments LEFT JOIN replies ON comments.comment_id=replies.comment_id WHERE comments.commentor_id='"+ userId +"' AND comments.comment_id='"+ commentId +"'")    // 此处用触发器，使朋友圈的comment_num-1    await query("DELETE FROM responses WHERE responses.responser_id='"+ userId +"' AND responses.response_id='"+ commentId +"'")    const data = {        status: 200    }    ctx.body = data})module.exports = router